# DecentDb Design Review

**Date:** 2026-01-28
**Reviewer:** Antigravity

## Summary
The design documents (`PRD`, `SPEC`, `TESTING_STRATEGY`) describe a pragmatic, well-scoped embedded database engine tailored for music library workloads. The decision to prioritize "Correctness via Testing" and limiting concurrency (Single Writer) is excellent for an MVP.

However, there are a few **Critical** design conflicts regarding the Concurrency/Checkpointing model that must be addressed before implementation, as well as some scope risks regarding Data Types.

## 1. Critical Design Issues

### 1.1. Checkpointing vs. Reader Snapshot Isolation (SPEC ยง4.3)
**Severity:** Critical ๐ด
**Location:** SPEC ยง4.3 (WAL size management) and ยง4.2 (Snapshot reads)

**The Issue:**
The SPEC states that during a checkpoint (even a "Forced Checkpoint"), the engine will:
1. Copy committed pages to the main DB.
2. **Truncate the WAL to zero.**
3. "Active readers continue with old page versions via **WAL overlay**."

**The Conflict:**
If the WAL is truncated to zero, the "WAL overlay" (the old frames) that active readers rely on is physical deleted/overwritten. This immediately corrupts the view of any active reader that needed an old version of a page (Snapshot Isolation violation).

**Recommendation:**
You cannot truncate the entire WAL if there are active readers.
*   **Option A (common):** Only truncate the WAL up to the `min(reader_lsn)` of all active readers. This means the WAL might grow beyond the limit during long-running reads, but correctness is preserved.
*   **Option B (complex):** Move necessary "old pages" to a separate "Shadow/Lookaside" file before truncating. (Not recommended for MVP).

*Proposed Change:* Remove "Forced Checkpoint" logic that claims to support active readers while truncating. Change logic to: "Checkpoint attempts to truncate. If readers are active, it checkpoints data but **defers truncation** of the WAL segment needed by readers until they finish."

### 1.2. Overflow Pages & Data Limits (SPEC ยง2.1.5, ยง3.3)
**Severity:** High ๐
**Location:** SPEC ยง2.1.5, ยง3.3

**The Issue:**
The SPEC lists "Overflow pages" as **"Optional MVP+"**.
However, the PRD supports `TEXT` and `BLOB` types, and the target use case is a Music Library (Lyrics, Cover Art).
*   A `PAGE_SIZE` is 4KB.
*   A single Cover Art image is often > 50KB.
*   The SPEC Suggests "allow inline with max threshold initially".

**The Conflict:**
If Overflow pages are not in MVP, you physically cannot store a row larger than ~4KB. This makes the database unusable for many "Decent" use cases (like storing images or long JSON blobs).

**Recommendation:**
*   **Option A:** Make Overflow Pages **mandatory for MVP**.
*   **Option B:** Explicitly remove `BLOB` support and cap `TEXT` length to ~1KB in the PRD for MVP.

Given the goal is a "Music Library", Option A is strongly preferred.

## 2. Feasibility & Scope

### 2.1. Foreign Key Enforcement (Statement vs Transaction)
The design enforces FKs at **Statement Time** (SPEC ยง7.2). This is a valid simplification but deviates from standard SQL (where you can insert Child, then Parent within the same Tx).
*   **Feedback:** Ensure this is clearly documented in the user-facing docs. It essentially disallows circular dependencies unless inserted in a specific order or technically impossible in some cyclic schemas without disabling checks.

### 2.2. Sorting & Memory
SPEC ยง11 mentions `sort_buffer_size` default of **1MB** and implies spilling to disk.
*   **Feedback:** Implementing "External Merge Sort" (spilling to disk) is a complex feature. For MVP, consider increasing the default memory limit (e.g., 64MB) and strictly effectively "InMemory Only" sorting, returning `ERR_MEMORY` if exceeded. 1MB is too small for a 9.5M row dataset sort (requires ~1GB for pointers/keys).

## 3. Consistency & Terminology

### 3.1. "WAL-only" Phrasing
PRD ยง1 mentions "ACID writes... WAL-only".
*   **Feedback:** This creates confusion with Log-Structured engines. The architecture is clearly "Paged File + WAL".
*   **fix:** Rephrase PRD to "WAL-based durability" or "Write-Ahead Logging".

### 3.2. PRD vs SPEC Alignment
*   **Aggregates:** PRD ยง3 originally listed Aggregates as Non-goals, but ยง3.7 Corrected this. SPEC includes them. (Aligned).
*   **Concurrency:** PRD mentions "Single writer + many concurrent readers". SPEC details "Single writer thread" pattern. (Aligned).

## 4. Testing Strategy
**Verdict:** Excellent.
The emphasis on "Faulty VFS", "Crash Injection", and "Differential Testing vs PostgreSQL" is the strongest part of this proposal. This strategy significantly increases the likelihood of a stable MVP.

## 5. Next Steps
1.  **Update SPEC** to fix the Checkpoint/Truncate logic (ensure readers don't lose WAL frames).
2.  **Decide** on Overflow Pages (In or Out for MVP).
3.  **Adjust** default memory config for Sort to be realistic for modern machines (16MB+).

