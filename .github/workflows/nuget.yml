name: Publish NuGet (.NET packages)

on:
  push:
    tags: [
      "v*"
    ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-native:
    name: Build native (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-x64
          - os: windows-latest
            rid: win-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: "stable"

      - name: Build libpg_query (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          git clone --depth 1 https://github.com/pganalyze/libpg_query.git /tmp/libpg_query
          cd /tmp/libpg_query
          make
          sudo make install
          sudo ldconfig

      - name: Build libpg_query (macOS)
        if: runner.os == 'macOS'
        run: |
          git clone --depth 1 https://github.com/pganalyze/libpg_query.git /tmp/libpg_query
          cd /tmp/libpg_query
          make
          sudo make install

      - name: Build libpg_query (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          repo_root="$PWD"
          git clone --depth 1 https://github.com/pganalyze/libpg_query.git /tmp/libpg_query
          cd /tmp/libpg_query
          make
          mkdir -p "$repo_root/build/lib"
          cp libpg_query.a "$repo_root/build/lib/"

      - name: Install dependencies
        run: nimble setup -y

      - name: Build native library (C API)
        run: nimble build_lib

      - name: Stage native (linux-x64)
        if: matrix.rid == 'linux-x64'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          if [ -f ./libdecentdb.so ]; then cp -v ./libdecentdb.so out/libdecentdb.so; fi
          if [ -f ./build/libdecentdb.so ]; then cp -v ./build/libdecentdb.so out/libdecentdb.so; fi
          if [ -f ./build/libc_api.so ]; then cp -v ./build/libc_api.so out/libdecentdb.so; fi
          test -f out/libdecentdb.so

      - name: Stage native (osx-x64)
        if: matrix.rid == 'osx-x64'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          if [ -f ./libdecentdb.dylib ]; then cp -v ./libdecentdb.dylib out/libdecentdb.dylib; fi
          if [ -f ./build/libdecentdb.dylib ]; then cp -v ./build/libdecentdb.dylib out/libdecentdb.dylib; fi
          if [ -f ./build/libc_api.dylib ]; then cp -v ./build/libc_api.dylib out/libdecentdb.dylib; fi
          test -f out/libdecentdb.dylib

      - name: Stage native (win-x64)
        if: matrix.rid == 'win-x64'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force out | Out-Null
          if (Test-Path .\decentdb.dll) { Copy-Item -Force .\decentdb.dll out\decentdb.dll }
          if (Test-Path .\build\decentdb.dll) { Copy-Item -Force .\build\decentdb.dll out\decentdb.dll }
          if (Test-Path .\build\c_api.dll) { Copy-Item -Force .\build\c_api.dll out\decentdb.dll }
          if (Test-Path .\build\libc_api.dll) { Copy-Item -Force .\build\libc_api.dll out\decentdb.dll }
          if (!(Test-Path .\out\decentdb.dll)) { throw "Native DLL not found" }

      - name: Upload native artifact
        uses: Wandalen/wretry.action@v3.8.0
        with:
          attempt_limit: 3
          attempt_delay: 10000
          action: actions/upload-artifact@v4
          with: |
            name: native-${{ matrix.rid }}
            path: out/

  pack-and-push:
    name: Pack + push NuGet
    runs-on: ubuntu-latest
    needs: [build-native]

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          path: native

      - name: Place native files into pack layout
        shell: bash
        run: |
          set -euo pipefail
          base="bindings/dotnet/src/DecentDB.MicroOrm"
          mkdir -p "$base/runtimes/linux-x64/native" "$base/runtimes/osx-x64/native" "$base/runtimes/win-x64/native"
          cp -v native/native-linux-x64/libdecentdb.so "$base/runtimes/linux-x64/native/libdecentdb.so"
          cp -v native/native-osx-x64/libdecentdb.dylib "$base/runtimes/osx-x64/native/libdecentdb.dylib"
          cp -v native/native-win-x64/decentdb.dll "$base/runtimes/win-x64/native/decentdb.dll"

      - name: Compute NuGet version from tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"

          if [[ "$tag" =~ ^v1\.0\.2$ ]]; then
            nuget="1.0.2"
          elif [[ "$tag" =~ ^v1\.0\.2-rc\.([0-9]+)$ ]]; then
            nuget="1.0.2-rc.${BASH_REMATCH[1]}"
          elif [[ "$tag" =~ ^v1\.0\.1$ ]]; then
            nuget="1.0.1"
          elif [[ "$tag" =~ ^v1\.0\.1-rc\.([0-9]+)$ ]]; then
            nuget="1.0.1-rc.${BASH_REMATCH[1]}"
          elif [[ "$tag" =~ ^v1\.0\.0$ ]]; then
            nuget="1.0.0"
          elif [[ "$tag" =~ ^v1\.0\.0-rc\.([0-9]+)$ ]]; then
            nuget="1.0.0-rc.${BASH_REMATCH[1]}"
          elif [[ "$tag" =~ ^v0\.1\.([0-9]+)$ ]]; then
            nuget="1.0.0-rc.${BASH_REMATCH[1]}"
          else
            echo "Unsupported tag: $tag" >&2
            exit 1
          fi

          echo "nuget_version=$nuget" >> "$GITHUB_OUTPUT"

      - name: Restore
        run: dotnet restore bindings/dotnet/DecentDB.NET.sln

      - name: Pack
        shell: bash
        run: |
          set -euo pipefail
          dotnet pack \
            -c Release \
            -p:PackageVersion="${{ steps.ver.outputs.nuget_version }}" \
            -o ./artifacts \
            bindings/dotnet/src/DecentDB.AdoNet/DecentDB.AdoNet.csproj
          dotnet pack \
            -c Release \
            -p:PackageVersion="${{ steps.ver.outputs.nuget_version }}" \
            -o ./artifacts \
            bindings/dotnet/src/DecentDB.MicroOrm/DecentDB.MicroOrm.csproj

      - name: Verify DecentDB.AdoNet package contents
        shell: bash
        run: |
          set -euo pipefail
          pkg="$(ls ./artifacts/DecentDB.AdoNet.*.nupkg | head -n1)"
          unzip -l "$pkg" | grep -q "lib/net10.0/DecentDB.AdoNet.dll"
          unzip -l "$pkg" | grep -q "lib/net10.0/DecentDB.Native.dll"
          unzip -l "$pkg" | grep -q "runtimes/linux-x64/native/libdecentdb.so"
          unzip -l "$pkg" | grep -q "runtimes/osx-x64/native/libdecentdb.dylib"
          unzip -l "$pkg" | grep -q "runtimes/win-x64/native/decentdb.dll"

      - name: Publish to GitHub Packages
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key "${{ secrets.GITHUB_TOKEN }}" \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --skip-duplicate

      - name: Publish to NuGet.org
        continue-on-error: true
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "$NUGET_API_KEY" ]; then
            dotnet nuget push ./artifacts/*.nupkg \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          else
            echo "NUGET_API_KEY not set, skipping NuGet.org publish"
            exit 1
          fi
